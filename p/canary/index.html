<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="一些关于canary的小知识">
<title>canary理解</title>

<link rel='canonical' href='https://psyduck-2005.github.io/p/canary/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="canary理解">
<meta property='og:description' content="一些关于canary的小知识">
<meta property='og:url' content='https://psyduck-2005.github.io/p/canary/'>
<meta property='og:site_name' content='Psyduck的秘密小窝'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2025-09-22T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-09-22T00:00:00&#43;00:00'/><meta property='og:image' content='https://psyduck-2005.github.io/p/canary/emperor.jpg' />
<meta name="twitter:title" content="canary理解">
<meta name="twitter:description" content="一些关于canary的小知识"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://psyduck-2005.github.io/p/canary/emperor.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_1f16404ee187731f.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Psyduck的秘密小窝</a></h1>
            <h2 class="site-description">For The Emperor</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/1311823396'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://deepseek.com'
                        target="_blank"
                        title="Deepseek"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" ?><svg id="Light" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><defs><style>.cls-1{fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;}</style></defs><title/><path class="cls-1" d="M19.267,19.326a12.206,12.206,0,0,0,4.11-8.576v-9a3,3,0,0,0-3,3,2.9,2.9,0,0,0,.045.44,2.985,2.985,0,0,0-4.545,2.56h2.5a2.5,2.5,0,0,1,0,5H6.877A15.648,15.648,0,0,0,.924,14.037a.5.5,0,0,0-.253.673C2.7,18.987,7.2,22.25,11.877,22.25a10.472,10.472,0,0,0,5.549-1.533"/><path class="cls-1" d="M1.535,16.25H5.461a4.006,4.006,0,0,1,2.855,1.207,7.873,7.873,0,0,0,5.061,2.293"/><path class="cls-1" d="M14.377,17.25a5.665,5.665,0,0,0,2,3,4.9,4.9,0,0,0,3.5.5l-1.5-3.5"/><path class="cls-1" d="M10.127,15.25a.25.25,0,0,1,.25.25"/><path class="cls-1" d="M9.877,15.5a.25.25,0,0,1,.25-.25"/><path class="cls-1" d="M10.127,15.75a.25.25,0,0,1-.25-.25"/><path class="cls-1" d="M10.377,15.5a.25.25,0,0,1-.25.25"/><path class="cls-1" d="M3.377,4.75a2.5,2.5,0,0,1,5,0"/><path class="cls-1" d="M13.377,4.75a2.5,2.5,0,0,0-5,0v6"/></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#canary简单介绍">canary简单介绍</a>
      <ol>
        <li><a href="#canary原理">canary原理</a></li>
        <li><a href="#canary初始化源码">canary初始化源码</a></li>
        <li><a href="#canary报错源码">canary报错源码</a></li>
      </ol>
    </li>
    <li><a href="#canary开启模式">canary开启模式</a>
      <ol>
        <li><a href="#-fstack-protector默认的栈保护"><code>-fstack-protector</code>（默认的栈保护）</a></li>
        <li><a href="#-fstack-protector-all强栈保护"><code>-fstack-protector-all</code>（强栈保护）</a></li>
        <li><a href="#其他保护类型">其他保护类型</a></li>
      </ol>
    </li>
    <li><a href="#canary检测绕过及利和防护">canary检测绕过及利和防护</a>
      <ol>
        <li><a href="#canary检测">canary检测</a></li>
        <li><a href="#canary绕过方法及其利用">canary绕过方法及其利用</a>
          <ol>
            <li><a href="#泄露">泄露</a></li>
            <li><a href="#劫持_stack_chk_fail">劫持_stack_chk_fail</a></li>
            <li><a href="#ssp-leak在227及以上版本已经失效">SSP Leak（在2.27及以上版本已经失效）</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#防御措施">防御措施</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/canary/">
                <img src="/p/canary/emperor_hu_651182b06c4c36d4.jpg"
                        srcset="/p/canary/emperor_hu_651182b06c4c36d4.jpg 800w, /p/canary/emperor_hu_dd43ed797f7d2693.jpg 1600w"
                        width="800" 
                        height="547" 
                        loading="lazy"
                        alt="Featured image of post canary理解" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/pwn/" >
                PWN
            </a>
        
            <a href="/categories/ctf/" >
                CTF
            </a>
        
            <a href="/categories/canary/" >
                CANARY
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/canary/">canary理解</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            一些关于canary的小知识
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-09-22</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 16 分钟
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="canary简单介绍">canary简单介绍
</h2><h3 id="canary原理">canary原理
</h3><p>canary是一种用来防护栈溢出的保护机制。其原理是在一个函数的入口处，先从fs/gs寄存器中取出一个4字节(eax)或者8字节,(其长度多半一个字长，rax)的值存到栈上，当函数结束时会检查这个栈上的值是否和存进去的值一致。canary在64位下保护包括rbp rip在内的数据,将其安排到前一个栈帧。
它的生命周期可以分为三个阶段:生成 -&gt; 存储 -&gt; 使用（校验）。</p>
<p><img src="/p/canary/1.jpg"
	width="444"
	height="465"
	srcset="/p/canary/1_hu_3423ef6e4ff1d1bd.jpg 480w, /p/canary/1_hu_b62398cb710fd66a.jpg 1024w"
	loading="lazy"
	
		alt="正常的canary"
	
	
		class="gallery-image" 
		data-flex-grow="95"
		data-flex-basis="229px"
	
> <img src="/p/canary/2.jpg"
	width="504"
	height="464"
	srcset="/p/canary/2_hu_c829143cfe28bdc4.jpg 480w, /p/canary/2_hu_f46c491734dff3f0.jpg 1024w"
	loading="lazy"
	
		alt="被覆盖的canary"
	
	
		class="gallery-image" 
		data-flex-grow="108"
		data-flex-basis="260px"
	
> <img src="/p/canary/3.jpg"
	width="548"
	height="339"
	srcset="/p/canary/3_hu_2e39f1a2353c7c4f.jpg 480w, /p/canary/3_hu_d7a92d6c61274bc4.jpg 1024w"
	loading="lazy"
	
		alt="跳转报错函数"
	
	
		class="gallery-image" 
		data-flex-grow="161"
		data-flex-basis="387px"
	
></p>
<ol>
<li>canary的生成：源头是安全随机</li>
</ol>
<p>在 Linux 系统上，这个值通常来自 /dev/urandom 这个内核提供的密码学安全伪随机数生成器（CSPRNG）。生成的 Canary 值通常是一个 64 位或 32 位的整数（取决于平台），并且其字节值通常会包含 0x00（空字节）。因为许多导致栈溢出的攻击向量是字符串操作函数（如 strcpy, gets）。这些函数在遇到空字节 0x00 时会停止复制。如果 Canary 中包含空字节，攻击者试图用字符串操作覆盖 Canary 时就会在中途停止，从而无法完整地覆盖和篡改它，导致攻击失败。</p>
<ol start="2">
<li>存储：线程本地存储 (TLS)</li>
</ol>
<p>生成的 Canary 值存储在哪里？它存储在 线程本地存储 (Thread-Local Storage, TLS) 中。并且每个线程拥有一个。一个程序可能有多个线程，每个线程都有自己的调用栈。如果所有线程共享一个全局的 Canary 值，那么一个线程泄漏了这个值，所有线程的保护就都失效了。为每个线程使用独立的 Canary 值可以隔离风险。</p>
<p><img src="/p/canary/4.jpg"
	width="839"
	height="853"
	srcset="/p/canary/4_hu_34d8fe5eb33477f9.jpg 480w, /p/canary/4_hu_e42b0ee96479d03b.jpg 1024w"
	loading="lazy"
	
		alt="多线程的canary工作,每个线程有自己独立的主金丝雀值（M1和M2不同）"
	
	
		class="gallery-image" 
		data-flex-grow="98"
		data-flex-basis="236px"
	
></p>
<ol start="3">
<li>访问：通过特殊寄存器(fs)</li>
</ol>
<p>在 x86-64 架构中，有一个特殊的段寄存器 %fs（或 %gs）用于指向 TLS。Canary 值通常位于 TLS 中的一个固定偏移处。编译器生成的代码会通过类似 %fs:0x28 这样的地址来访问当前线程的 Canary 值。</p>
<ol start="4">
<li>使用与校验：函数序言和尾声</li>
</ol>
<p>现在，我们看一个函数是如何使用这个值的：</p>
<ul>
<li>函数序言 (Prologue)：
当一个被保护的函数开始时，编译器插入的代码会做两件事：从 TLS（如 %fs:0x28）中取出当前线程的 Canary 值。将这个 Canary 值压入到该函数栈帧上的一个特定位置（通常就在保存的基指针和返回地址之前）。</li>
</ul>
<p>汇编代码看起来像这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>    <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="nv">%fs</span><span class="p">:</span><span class="mi">0x28</span><span class="p">]</span>  <span class="c1">; 从TLS中取出Canary值到rax寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span>    <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">],</span> <span class="no">rax</span>    <span class="c1">; 将Canary值压入栈上的保护位置
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>函数尾声 (Epilogue)：
在函数返回（ret指令）之前，编译器插入的代码会：从栈上之前保存的位置读出 Canary 值。将其与 TLS 中存储的原始 Master Canary 值进行比较。如果两者相等，程序正常返回。如果不相等，说明栈上的 Canary 在函数执行过程中被溢出数据覆盖了，此时会立即跳转到 __stack_chk_fail 函数。</li>
</ul>
<p>汇编代码看起来像这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">mov</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span> <span class="p">-</span> <span class="mi">8</span><span class="p">]</span>    <span class="c1">; 从栈上取出保存的Canary值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">sub</span>    <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="nv">%fs</span><span class="p">:</span><span class="mi">0x28</span><span class="p">]</span>   <span class="c1">; 与TLS中的原始值进行比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">je</span>     <span class="no">.return_normal</span>              <span class="c1">; 如果相等（结果为0），跳转到返回指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">call</span>   <span class="no">__stack_chk_fail</span>            <span class="c1">; 否则，调用失败处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.return_normal:</span>
</span></span><span class="line"><span class="cl"><span class="nf">leave</span>
</span></span><span class="line"><span class="cl"><span class="nf">ret</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>__stack_chk_fail 函数会打印出著名的 &ldquo;*** stack smashing detected ***: <program name> terminated&rdquo; 错误信息，然后调用 abort() 终止程序，阻止攻击者代码执行。</p>
<h3 id="canary初始化源码">canary初始化源码
</h3><p>security_init.c函数部分源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">security_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _dl_random的值在进入这个函数之前已由内核写入（通常在程序启动时）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Glibc直接使用_dl_random的值，而不是自己生成随机数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 将_dl_random的最后一个字节设置为0x0（通过_dl_setup_stack_chk_guard函数）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">uintptr_t</span> <span class="n">stack_chk_guard</span> <span class="o">=</span> <span class="nf">_dl_setup_stack_chk_guard</span><span class="p">(</span><span class="n">_dl_random</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 设置Canary的值到当前线程的TLS（线程本地存储）中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">THREAD_SET_STACK_GUARD</span> <span class="p">(</span><span class="n">stack_chk_guard</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 将_dl_random置为NULL，防止后续使用（可能出于安全原因）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_dl_random</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 后续可能还有其他安全初始化操作（注释提到&#34;下面就是对canary的一些准备&#34;）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关键宏定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define THREAD_SET_STACK_GUARD(value) \
</span></span></span><span class="line"><span class="cl"><span class="cp">    THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>解释：</p>
<pre><code>  _dl_random：这是一个由内核提供的随机值（通常通过AT_RANDOM AUXV条目传递），作为栈保护canary的种子。

  _dl_setup_stack_chk_guard：这个函数处理canary的生成：

  使用`_dl_random`作为输入,将最后一个字节设置为0（这是为了阻止C字符串函数覆盖canary值，因为许多字符串漏洞依赖NULL终止符）

  THREAD_SET_STACK_GUARD：这个宏将生成的canary值存储到当前线程的TLS中：

  THREAD_SELF:获取当前线程的TLS指针

  header.stack_guard是TLS中存储栈保护值的字段位置

  使用THREAD_SETMEM将值写入指定位置

  _dl_random = NULL：清除随机值源，可能是为了：减少攻击面,防止意外重复使用
</code></pre>
</li>
<li>
<p>完整的数据流</p>
<pre><code>  内核 → 通过AT_RANDOM AUXV条目提供 _dl_random

  _dl_setup_stack_chk_guard → 处理随机值，设置最后字节为0

  THREAD_SET_STACK_GUARD → 将canary存储到当前线程TLS

  编译器 → 在函数 prologue/epilogue 中插入canary检查代码
</code></pre>
</li>
</ul>
<p><strong>uintptr_t<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>数据类型解释</strong></p>
<h3 id="canary报错源码">canary报错源码
</h3><p>stack_chk_fail.c源码解析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">libc_message</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;** %s ***: %s terminated</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">__libc_argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?:</span> <span class="s">&#34;&lt;unknown&gt;&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>函数调用</li>
</ol>
<p><code>libc_message()</code>: GNU C库内部的函数，用于输出系统消息,2: 第一个参数，通常表示标准错误输出（stderr）</p>
<ol start="2">
<li>格式化字符串</li>
</ol>
<p><code>&quot;** %s ***: %s terminatedn&quot;</code>: 格式化字符串模板,第一个 %s: 将被 msg 替换,第二个 %s: 将被程序名替换</p>
<ol start="3">
<li>参数</li>
</ol>
<p>msg: 具体的错误消息字符串
<code>__libc_argv[0]?: &quot;&lt;unknown&gt;&quot;</code></p>
<p><code>__libc_argv[0]</code>: 程序的名称（argv[0]）
<code>?: &quot;&lt;unknown&gt;&quot;:</code> 三元条件运算符，如果程序名为空则使用<code>&quot;&lt;unknown&gt;&quot;</code></p>
<ol start="4">
<li>实际输出示例</li>
</ol>
<p>如果 msg = &ldquo;stack smashing detected&rdquo;，程序名为 ./test，输出将是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">** stack smashing detected ***: ./test terminated
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="canary开启模式">canary开启模式
</h2><p>canary主要分为三种（关闭/开启/全开启）</p>
<p><code>-fstack-protector</code> 和 <code>-fstack-protector-all</code> 都是用于防范栈溢出攻击的保护机制，但它们的保护范围和性能影响有显著区别。</p>
<h3 id="-fstack-protector默认的栈保护"><code>-fstack-protector</code>（默认的栈保护）
</h3><p>这是选择性保护模式。编译器会进行启发式判断，只对包含敏感操作（如字符数组操作）或容易遭受攻击的函数插入保护代码。</p>
<p>保护对象：满足以下条件的函数：</p>
<ol>
<li>使用了 alloca() 函数在栈上动态分配内存的。</li>
<li>定义了大于 8 字节的<strong>字符</strong>数组（char） 或缓冲区（通常是可能发生溢出的源头）的局部变量。</li>
</ol>
<p>性能：性能开销较小。因为只对一部分“危险”函数进行保护，生成的代码量更小，运行时检查也更少。
安全性：保护范围有限。它可能会错过一些不那么明显但依然存在漏洞的函数。例如，一个使用 int 数组但可能溢出的函数就不会被保护。
用途：这是 GCC 的默认行为（如果启用了栈保护）。在安全性和性能之间提供了一个很好的平衡，适用于大多数情况。</p>
<p>示例：会被 <code>-fstack-protector</code> 保护的函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">vulnerable_function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span> <span class="c1">// 大的字符数组 -&gt; 会被保护
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span> <span class="c1">// 危险操作！
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="-fstack-protector-all强栈保护"><code>-fstack-protector-all</code>（强栈保护）
</h3><p>这是全面保护模式。编译器会为所有函数插入保护代码，无论其是否看起来存在风险。
保护对象：每一个函数，无论其内部结构如何。</p>
<p>性能：性能开销较大。每个函数在入口和出口都有额外的代码来设置和检查金丝雀值。这会导致生成的二进制文件更大，运行速度稍慢。
安全性：保护范围非常全面。消除了由于编译器启发式判断失误而漏掉漏洞的可能性，提供了更深度的防御。
用途：用于对安全性要求极高的环境，愿意为此牺牲一定的性能。例如，处理不受信任输入的特权程序（sudo, sshd 等）、安全关键型的系统。</p>
<p>示例：会被<code>-fstack-protector-all</code>保护的函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">innocent_looking_function</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">array</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">// 整型数组，通常不会被启发式规则认为是危险的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 糟糕！这里有一个“差一错误”（Off-by-one）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 当 i=10 时，会发生栈溢出，覆盖返回地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 使用 `-fstack-protector` 可能不会保护此函数，但 `-fstack-protector-all` 会。
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="其他保护类型">其他保护类型
</h3><p><code>-fstack-protector-strong</code>：这是一个介于 <code>-fstack-protector</code> 和 <code>-fstack-protector-all</code> 之间的选项（GCC 4.9 引入）。它扩展了启发式规则，比 <code>-fstack-protector</code> 保护更多的函数（例如，包含任何类型的数组、有局部变量地址被使用的函数），在不过度增加开销的情况下提供了更好的保护。在许多现代Linux发行版中，这已成为默认的编译选项。</p>
<p><code>-fno-stack-protector</code>：完全禁用栈保护。</p>
<h2 id="canary检测绕过及利和防护">canary检测绕过及利和防护
</h2><h3 id="canary检测">canary检测
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_stack_canary</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 从第一个参数开始探测</span>
</span></span><span class="line"><span class="cl">    <span class="n">binary</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>  <span class="c1"># 存储接收到的数据</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># 最多探测100个参数</span>
</span></span><span class="line"><span class="cl">        <span class="n">payload</span> <span class="o">=</span> <span class="s2">&#34;%&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;$p&#34;</span>  <span class="c1"># 格式化字符串payload：读取第i个参数</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span> <span class="o">=</span> <span class="n">getio</span><span class="p">()</span>  <span class="c1"># 获取IO连接（可能是到目标程序的连接）</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>  <span class="c1"># 发送payload</span>
</span></span><span class="line"><span class="cl">        <span class="n">recv</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>  <span class="c1"># 接收响应</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">binary</span> <span class="o">=</span> <span class="n">recv</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 取响应内容的最后几个字节（可能有误）</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">binary</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&#34;00&#34;</span><span class="p">:</span>  <span class="c1"># 检查特定模式（这里逻辑可能有问题）</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;--找到一个可疑的偏移：&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">recv</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span> <span class="o">+</span> <span class="s2">&#34;--&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;正在进行二次测试&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">p</span> <span class="o">=</span> <span class="n">getio</span><span class="p">()</span>  <span class="c1"># 重新建立连接进行验证</span>
</span></span><span class="line"><span class="cl">            <span class="n">payload_2</span> <span class="o">=</span> <span class="s2">&#34;%&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;$p&#34;</span>  <span class="c1"># 同样的payload</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">recv2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">recv2</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">recv</span><span class="p">[</span><span class="mi">6</span><span class="p">:]:</span>  <span class="c1"># 如果两次结果不同</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;...他是canary的几率很大:&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">recv2</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span> <span class="o">+</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">log</span><span class="o">.</span><span class="n">failure</span><span class="p">(</span><span class="s2">&#34;--哦，他不是canary--&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># 测试下一个参数</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这是一个canary自动检测方案（不需要手打%p，来自B站某up）</p>
<h3 id="canary绕过方法及其利用">canary绕过方法及其利用
</h3><h4 id="泄露">泄露
</h4><ol>
<li>
<p>格式化字符串泄露</p>
<ul>
<li>定位Canary：首先需要确定Canary在栈上的偏移位置。在格式化字符串漏洞中，我们可以使用类似 %p %p %p %p &hellip; 或 %n$p（n是位置参数）的方式来“窥探”栈上的内容。</li>
<li>识别Canary：Canary的值通常以字节 0x00 结尾（这是为了阻止使用字符串操作函数如 strcpy 来泄露它，因为 strcpy 遇到 0x00 会终止）。所以当我们从栈上泄露出一串地址，其中一个值最后两个字节是 00（例如 0x1b2d3c4d5a6b00），它极有可能就是Canary。</li>
<li>构造Payload：在后续的溢出中，在覆盖到Canary的位置时，精确地用我们泄露出来的这个值填充，这样函数尾声的校验就会通过，程序不会崩溃，攻击得以继续。</li>
<li>在这之中包括另外一种泄露:Canry的最底一个字节设计为b’\x00’，是为了防止put，write，printf登将canary读出。如果利用栈溢出将最低位的b’\x00’覆盖，就可以利用答应函数将canary一致输出，最后再在最低位拼接上 b&rsquo;\x00&rsquo;就可以得到canary。</li>
</ul>
</li>
<li>
<p>爆破（fork）</p>
<p>原理：爆破（Brute-Force）Canary（适用于fork服务）这种方法常用于网络服务，这些服务使用 fork() 模式来处理客户端连接（例如，一个主进程监听，每来一个连接就fork一个子进程来处理）。</p>
<ul>
<li>
<p>进程内存镜像复制（Fork）：fork() 创建的子进程会完整地复制父进程的内存空间。这意味着每个连接对应的子进程，其Canary值是完全相同的。</p>
</li>
<li>
<p>逐字节爆破：Canary通常是一个4字节（32位）或8字节（64位）的值，但其最后一个字节固定为 0x00。所以我们只需要爆破前面的3或7个字节。攻击者可以多次连接服务，每次尝试爆破Canary的一个字节。从最低位字节（LSB）开始（注意小端序，内存中第一个字节是最低位）。利用栈溢出，溢出到canary位置，从低位到高位 逐次覆盖掉canary的4个字节(一位无法绕过低位字节堆高位进行爆破，所以必须从低到高)，且要求canary不能变化，绕过重开程序canary变化，就不适用爆破了。例如，对于一个64位Canary 0x00 0xab 0xcd 0xef 0x12 0x34 0x56 0x78，爆破顺序是从 0x78 开始，然后是 0x56，依此类推，直到 0xab（0x00 不用爆，直接填）。利用崩溃反馈：攻击者发送一个精心构造的payload：[填充缓冲区的垃圾数据] + [已猜解的部分Canary] + [尝试爆破的下一个字节]。如果这个字节猜对了，Canary校验通过，程序不会崩溃，可能会因为后续的返回地址错误而表现出其他行为（比如连接意外断开或无响应）。如果猜错了，__stack_chk_fail 会被触发，子进程立刻崩溃。攻击者通过观察连接是否“立即断开”（崩溃）来判断字节是否猜对。重复过程：从一个字节开始，逐步猜出整个Canary。因为每次猜一个字节（256种可能性），所以最多只需要 7 * 256 = 1792 次尝试，这在计算上是完全可行的。</p>
</li>
<li>
<p>基于每次连接fork出的新进程，其Canary都和上一次一样。上次猜对的字节，这次依然有效，所以可以基于已知字节继续猜下一个。</p>
</li>
</ul>
</li>
<li>
<p>连带输出</p>
<p>这种方法利用了格式化字符串和程序逻辑的结合。</p>
<p>原理漏洞组合：程序存在两个漏洞：</p>
<ul>
<li>一个栈溢出漏洞（用于覆盖Canary和返回地址）。</li>
<li>一个格式化字符串漏洞（用于泄露信息）。</li>
</ul>
<p>触发流程：</p>
<ul>
<li>攻击者首先构造一个不完全的溢出Payload。这个Payload会覆盖Canary之后的一部分栈空间，但故意不覆盖Canary本身（或者用可能正确的值覆盖，期望它能通过），而是去覆盖一个即将被格式化字符串函数使用的参数（比如格式化字符串的指针本身，或者一个指向指针的指针）。</li>
<li>程序执行流继续，并没有因为栈溢出而崩溃（因为Canary没被破坏或碰巧猜对了）。</li>
<li>程序随后执行到存在格式化字符串漏洞的代码（例如 printf(user_input)）。但此时，栈上的状态已经被之前的溢出Payload修改了。</li>
<li>被修改的栈空间，恰好控制了格式化字符串函数的一个或多个参数。攻击者可以精心设计，让这个格式化字符串（例如 %n$p）去读取并输出栈上任意位置的值，其中就包括真正的Canary。</li>
<li>程序将这个Canary值打印（输出） 给攻击者。</li>
<li>完成攻击：攻击者拿到Canary后，就可以在第二次交互中，构造一个完整的、包含正确Canary的ROP链Payload，最终实现利用。
这种方法的核心是“用一次不完美的溢出来为格式化字符串漏洞配置环境，从而泄露关键信息，为第二次的攻击做准备”。</li>
</ul>
</li>
</ol>
<h4 id="劫持_stack_chk_fail">劫持_stack_chk_fail
</h4><ol>
<li>
<p>函数行为</p>
<p>检测到栈溢出：如果攻击者通过栈溢出（例如，缓冲区溢出）覆盖了函数的返回地址，那么很可能会同时覆盖这个金丝雀值。函数在返回前检查发现金丝雀值不匹配，就会调用 <code>__stack_chk_fail</code> 函数。</p>
<ul>
<li>行为：<code>__stack_chk_fail</code> 的默认实现是打印一条错误信息（如 &ldquo;** stack smashing detected **&quot;）并立即终止程序（通常通过 abort()）。</li>
</ul>
</li>
<li>
<p>劫持 <code>__stack_chk_fail</code>目的</p>
<ul>
<li>获取程序控制流：在栈溢出攻击中，攻击者可能无法精确地控制金丝雀值。如果触发了栈保护，程序会崩溃，攻击失败。通过劫持<code>__stack_chk_fail</code>，攻击者可以将崩溃转化为机会：不让程序简单地退出，而是让它跳转到攻击者控制的代码（Shellcode）。</li>
<li>信息泄露：在某些高级攻击中（如通过覆盖局部变量实现的部分写），可能故意触发 <code>__stack_chk_fail</code> 来泄露内存信息或其他数据。</li>
<li>绕过保护：这是最直接的动机。通过控制 <code>__stack_chk_fail</code> 的行为，攻击者实质上禁用或绕过了栈保护机制，使得传统的栈溢出攻击得以继续。</li>
</ul>
</li>
<li>
<p>劫持 <code>__stack_chk_fail</code>方法</p>
<p>覆盖程序运行时使用的 <code>__stack_chk_fail</code> 函数的地址。主要有以下几种方法：</p>
<ul>
<li>
<p>修改 GOT 表（全局偏移表）这通常是 基于二进制漏洞利用 的首选方法，因为它不需要源代码。
在 Linux 等使用 ELF 格式的系统中，共享库函数（如<code>__stack_chk_fail</code>，它位于 libc 中）的地址存储在名为 GOT 的数据段中。程序在调用 <code>__stack_chk_fail</code> 时，实际上是通过 GOT 表进行间接跳转。使用 objdump -R ./binary 或 readelf -r ./binary 命令查找<code>__stack_chk_fail</code> 在 GOT 中的地址。你会看到一条记录，显示 <code>__stack_chk_fail@got.plt</code> 的地址（例如 0x804a00c）。
找到你的 Shellcode 在内存中的地址（例如 0xffffd100）。</p>
</li>
<li>
<p>利用漏洞：通过栈溢出或其他内存破坏漏洞（如格式化字符串漏洞），将 GOT 表中 <code>__stack_chk_fail</code> 的条目覆盖为你想要的地址（例如你的 Shellcode 地址）。</p>
</li>
<li>
<p>触发检查：故意造成一个栈溢出，触发栈保护检查。程序会照常去调用 <code>__stack_chk_fail</code>，但由于 GOT 表被修改，它实际上会跳转到你的 Shellcode 地址，从而执行你的代码。</p>
</li>
</ul>
</li>
</ol>
<h4 id="ssp-leak在227及以上版本已经失效">SSP Leak（在2.27及以上版本已经失效）
</h4><h2 id="防御措施">防御措施
</h2><p>现代系统针对这种劫持技术也有相应的防御措施：</p>
<p>RELRO（Relocations Read-Only）是一种用于增强 Linux 下 ELF 二进制文件安全性的安全加固技术。它的主要目标是保护 ELF 二进制文件中的某些关键数据结构（主要是动态链接相关的部分）在运行时不被恶意修改，从而防止一系列利用漏洞（如全局偏移表GOT覆盖攻击）的攻击手段。
要理解 RELRO，首先要理解它要解决的安全问题：GOT 覆盖攻击</p>
<ul>
<li>
<p>动态链接：Linux 上的程序为了节省内存，通常会动态链接到像 libc 这样的共享库。这意味着程序在运行时才知道这些库函数的实际内存地址。
全局偏移表（GOT）：为了实现动态链接，编译器会创建一个叫做 GOT 的数据结构。它可以被理解为一个“函数地址查询表”。当程序第一次调用一个共享库函数（如 printf）时，动态链接器会找到 printf 的真实地址，并将其写入到 GOT 中对应的条目。之后每次调用 printf，程序就直接从 GOT 中读取地址并跳转过去。
安全问题：GOT 表是可写的。这是一个致命的安全隐患。如果攻击者通过一个漏洞（如栈缓冲区溢出或格式化字符串漏洞）能够向任意内存地址写入数据，他们就可以：
找到要攻击的函数的 GOT 表地址（例如 system 或 __stack_chk_fail 的 GOT 条目）。这个条目覆盖为他们想要的地址（例如 /bin/sh 的地址，或者他们自己的 Shellcode 地址）。当下一次程序调用这个被劫持的函数时，控制流就会跳转到攻击者指定的地址，从而完成攻击。RELRO 就是为了解决这个“GOT 表可写”的问题而诞生的。</p>
<ul>
<li>
<p>RELRO 有两种级别，提供不同强度的保护：</p>
<ol>
<li>部分 RELRO（Partial RELRO） -Wl,-z,relro
这是 GCC 的默认编译选项（除非你用 -Wl,-z,norelro 显式关闭）。
<ul>
<li>重排序段：它让链接器重新排列 ELF 文件中的各个数据段（section），将 ELF 内部的数据段（如 .got, .dtors, .ctors 等）放在程序的数据段（如 .data 和 .bss）之前。这可以防止一些基于全局变量溢出的攻击，因为溢出会向后覆盖，而关键数据段在前面，不会被覆盖到。</li>
<li>标记只读：它将 GOT 表 之前的 .got.plt 部分（包含过程链接表PLT使用的GOT条目）标记为只读。但注意，完整的 GOT 表（.got）仍然是可写的，因为延迟绑定（lazy binding）机制需要写入它。</li>
<li>安全性：部分 RELRO 无法防止针对 GOT 表的覆盖攻击，因为 .got 仍然可写。它主要缓解的是其他一些不那么常见的攻击向量。</li>
</ul>
</li>
<li>完全 RELRO（Full RELRO） -Wl,-z,relro,-z,now这是更严格、更安全的模式。
<ul>
<li>它包含了部分 RELRO 的所有保护措施。它禁用了延迟绑定（lazy binding）。程序在启动阶段，由动态链接器 (ld-linux.so) 一次性解析并填充所有外部函数的真实地址到 GOT 表中。</li>
<li>在完成所有符号解析后，将整个 GOT 表（包括 .got 和 .got.plt）标记为只读。</li>
<li>安全性：完全 RELRO 可以有效防止 GOT 覆盖攻击。因为攻击者再也无法向 GOT 表写入任何数据。</li>
<li>启动时间变长：因为所有动态链接符号都在程序开始时解析，而不是在第一次调用时解析，这导致程序的启动时间稍微增加。对于依赖大量共享库的大型程序（如 Firefox,LibreOffice），这个影响可能更明显。</li>
<li>内存占用：所有符号都被立即解析，可能会稍微增加初始内存占用。</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<p>一篇关于ASLR的论文</p>
<p><a class="link" href="https://seclists.org/oss-sec/2018/q1/195"  target="_blank" rel="noopener"
    >Linux 上 ASLR 的新旁路和保护技术</a></p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>这是无符号整数类型，具有以下关键特性：</p>
<ul>
<li>类型定义：在 &lt;stdint.h&gt; 头文件中定义</li>
<li>用途：能够安全地存储指针值的无符号整数类型</li>
<li>保证：任何有效的（void*）指针都可以转换为uintptr_t，然后再转换回（void*）而不会丢失信息</li>
<li>平台兼容性：指针大小随架构变化（32位 vs 64位），uintptr_t <strong>会自动匹配当前平台的指针大小</strong></li>
<li>整数运算：canary值需要进行位操作（如设置最后字节为0），使用整数类型便于进行位运算，但需要保证与指针相同的位宽</li>
</ul>
&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></li>
</ol>
</div>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/ptmalloc2/">
        
        
            <div class="article-image">
                
                    <img src="/helena-hertz-wWZzXlDpMog-unsplash.jpg" loading="lazy" data-key="ptmalloc2" data-hash="/helena-hertz-wWZzXlDpMog-unsplash.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ptmalloc2理解</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 psyduck2005
    </section>
    
    <section class="powerby">
        
            我受到了召唤，我必须回应，一如既往 <br/>
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.31.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
